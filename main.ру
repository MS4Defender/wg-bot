import asyncio
import json
import os
import random
import string
from aiogram import Bot, Dispatcher
from aiogram.types import Message, CallbackQuery
from aiogram.filters import CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from datetime import datetime, timedelta

TOKEN = "8366390176:AAEQYj53bEaXLtyq6QcYE_QJEObSTul-qW0"
OWNER_ID = 1056116070  # –¢–í–û–ô Telegram ID

bot = Bot(token=TOKEN)
dp = Dispatcher()

# –§–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
USERS_FILE = "users.json"
PROMOCODES_FILE = "promocodes.json"
ADMINS_FILE = "admins.json"


# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
def load_data(filename, default):
    if os.path.exists(filename):
        with open(filename, "r", encoding="utf-8") as f:
            return json.load(f)
    return default


def save_data(filename, data):
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
users = load_data(USERS_FILE, {})

# –ü—Ä–æ–º–æ–∫–æ–¥—ã
promocodes = load_data(PROMOCODES_FILE, {})

# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
admins = load_data(ADMINS_FILE, [OWNER_ID])

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
admin_states = {}


def is_admin(user_id):
    return user_id in admins


def is_owner(user_id):
    return user_id == OWNER_ID


def generate_promo_code(length=6):
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=length))


@dp.message(CommandStart())
async def start(message: Message):
    user_id = str(message.from_user.id)
    if user_id not in users:
        users[user_id] = {"balance": 0, "last_luck": None}
        save_data(USERS_FILE, users)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞", callback_data="game")],
        [InlineKeyboardButton(text="üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data="shop")],
        [InlineKeyboardButton(text="üéÅ –£–¥–∞—á–∞", callback_data="luck")],
        [InlineKeyboardButton(text="üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="rules")],
        [InlineKeyboardButton(text="üéü –ü—Ä–æ–º–æ–∫–æ–¥", callback_data="promo")]
    ])

    if is_admin(int(user_id)):
        keyboard.inline_keyboard.append([InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin")])

    await message.answer(
        "üèπ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Ç—É—Ä–Ω–∏—Ä WG!\n\n"
        f"üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: {users[user_id]['balance']} –º–æ–Ω–µ—Ç\n\n"
        "–ò–≤–µ–Ω—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.\n"
        "–ì–æ—Ç–æ–≤ –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É?",
        reply_markup=keyboard
    )


@dp.callback_query(lambda c: c.data == "luck")
async def process_luck(callback: CallbackQuery):
    luck_keyboard = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üé≤ –£–¥–∞—á–∞")]],
        resize_keyboard=True,
        one_time_keyboard=False
    )

    await callback.message.answer(
        "üëá –ù–∞–∂–º–∏ –Ω–∞ –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É!\n"
        "–î–æ—Å—Ç—É–ø–Ω–æ **1 —Ä–∞–∑ –≤ 24 —á–∞—Å–∞**",
        reply_markup=luck_keyboard
    )
    await callback.answer()


@dp.message(lambda message: message.text == "üé≤ –£–¥–∞—á–∞")
async def give_luck(message: Message):
    user_id = str(message.from_user.id)
    now = datetime.now()

    if users[user_id]["last_luck"]:
        last_used = datetime.fromisoformat(users[user_id]["last_luck"])
        time_diff = now - last_used

        if time_diff < timedelta(hours=24):
            remaining = timedelta(hours=24) - time_diff
            hours = remaining.seconds // 3600
            minutes = (remaining.seconds % 3600) // 60

            await message.answer(
                f"‚è≥ –ü–æ–¥–æ–∂–¥–∏ –µ—â—ë {hours} —á {minutes} –º–∏–Ω –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏!"
            )
            return

    coins = random.randint(0, 1000)
    users[user_id]["balance"] += coins
    users[user_id]["last_luck"] = now.isoformat()
    save_data(USERS_FILE, users)

    await message.answer(
        f"üé≤ –¢–µ–±–µ –≤—ã–ø–∞–ª–æ: {coins} –º–æ–Ω–µ—Ç!\n"
        f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {users[user_id]['balance']}"
    )


@dp.callback_query(lambda c: c.data == "promo")
async def promo_button(callback: CallbackQuery):
    await callback.message.answer(
        "üéü –í–≤–µ–¥–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –≤ —á–∞—Ç:\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: ABC123"
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin")
async def admin_panel(callback: CallbackQuery):
    user_id = callback.from_user.id
    if not is_admin(user_id):
        await callback.answer("‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!", show_alert=True)
        return

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéü –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥", callback_data="admin_create_promo")],
        [InlineKeyboardButton(text="üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤", callback_data="admin_list_promos")],
        [InlineKeyboardButton(text="üí∞ –ù–∞—á–∏—Å–ª–∏—Ç—å –º–æ–Ω–µ—Ç—ã", callback_data="admin_give")],
        [InlineKeyboardButton(text="üë• –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤", callback_data="admin_list")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ])

    if is_owner(user_id):
        keyboard.inline_keyboard.insert(0, [
            InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞", callback_data="admin_add"),
            InlineKeyboardButton(text="‚ûñ –£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∞", callback_data="admin_remove")
        ])

    await callback.message.edit_text(
        "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin_add")
async def add_admin_start(callback: CallbackQuery):
    if not is_owner(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü!", show_alert=True)
        return

    admin_states[callback.from_user.id] = "adding_admin"

    await callback.message.answer(
        "‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
        "–í–≤–µ–¥–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
        "–ü—Ä–∏–º–µ—Ä: `123456789`"
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin_remove")
async def remove_admin_start(callback: CallbackQuery):
    if not is_owner(callback.from_user.id):
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü!", show_alert=True)
        return

    admin_states[callback.from_user.id] = "removing_admin"

    await callback.message.answer(
        "‚ûñ –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
        "–í–≤–µ–¥–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
        "–ü—Ä–∏–º–µ—Ä: `123456789`"
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin_create_promo")
async def create_promo_start(callback: CallbackQuery):
    if not is_admin(callback.from_user.id):
        await callback.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!", show_alert=True)
        return

    admin_states[callback.from_user.id] = "creating_promo"

    await callback.message.answer(
        "üéü –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞\n\n"
        "–í–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`—Å—É–º–º–∞ –ª–∏–º–∏—Ç`\n\n"
        "–ü—Ä–∏–º–µ—Ä: 500 3 - –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 500 –º–æ–Ω–µ—Ç, 3 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n\n"
        "–ò–ª–∏:\n"
        "`—Å—É–º–º–∞ –ª–∏–º–∏—Ç –ö–û–î` - –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–≤–æ–π –∫–æ–¥\n"
        "–ü—Ä–∏–º–µ—Ä: `1000 1 WIN2025`",
        parse_mode="Markdown"
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin_give")
async def give_money_start(callback: CallbackQuery):
    if not is_admin(callback.from_user.id):
        await callback.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!", show_alert=True)
        return

    admin_states[callback.from_user.id] = "giving_money"

    await callback.message.answer(
        "üí∞ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç\n\n"
        "–í–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`user_id —Å—É–º–º–∞`\n\n"
        "–ü—Ä–∏–º–µ—Ä: `123456789 500`"
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "admin_list_promos")
async def list_promos(callback: CallbackQuery):
    if not is_admin(callback.from_user.id):
        await callback.answer("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!", show_alert=True)
        return

    if not promocodes:
        await callback.message.answer("üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤")
        await callback.answer()
        return

    text = "üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:\n\n"
    for code, data in promocodes.items():
        text += f"‚Ä¢ {code}: {data['value']} –º–æ–Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ {data['uses']}/{data['max_uses']}\n"

    await callback.message.answer(text, parse_mode="Markdown")
    await callback.answer()


@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: CallbackQuery):
    user_id = str(callback.from_user.id)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞", callback_data="game")],
        [InlineKeyboardButton(text="üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data="shop")],
        [InlineKeyboardButton(text="üéÅ –£–¥–∞—á–∞", callback_data="luck")],
        [InlineKeyboardButton(text="üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="rules")],
        [InlineKeyboardButton(text="üéü –ü—Ä–æ–º–æ–∫–æ–¥", callback_data="promo")]
    ])

    if is_admin(callback.from_user.id):
        keyboard.inline_keyboard.append([InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin")])

    await callback.message.edit_text(
        "üèπ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Ç—É—Ä–Ω–∏—Ä WG!\n\n"
        f"üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: {users[user_id]['balance']} –º–æ–Ω–µ—Ç\n\n"
        "–ò–≤–µ–Ω—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.\n"
        "–ì–æ—Ç–æ–≤ –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É?",
        reply_markup=keyboard
    )
    await callback.answer()


@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: CallbackQuery):
    user_id = str(callback.from_user.id)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞", callback_data="game")],
        [InlineKeyboardButton(text="üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data="shop")],
        [InlineKeyboardButton(text="üéÅ –£–¥–∞—á–∞", callback_data="luck")],
        [InlineKeyboardButton(text="üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="rules")],
        [InlineKeyboardButton(text="üéü –ü—Ä–æ–º–æ–∫–æ–¥", callback_data="promo")]
    ])

    if is_admin(callback.from_user.id):
        keyboard.inline_keyboard.append([InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin")])

    await callback.message.edit_text(
        "üèπ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Ç—É—Ä–Ω–∏—Ä WG!\n\n"
        f"üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: {users[user_id]['balance']} –º–æ–Ω–µ—Ç\n\n"
        "–ò–≤–µ–Ω—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.\n"
        "–ì–æ—Ç–æ–≤ –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É?",
        reply_markup=keyboard
    )
    await callback.answer()


# –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω–æ–≤
@dp.message()
async def handle_admin_actions(message: Message):
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–∞–∫–æ–º-—Ç–æ —Ä–µ–∂–∏–º–µ
    if user_id not in admin_states:
        # –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã
        await handle_promo_logic(message)
        return

    state = admin_states[user_id]

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    if state == "adding_admin" and is_owner(user_id):
        try:
            new_admin_id = int(message.text.strip())
            if new_admin_id not in admins:
                admins.append(new_admin_id)
                save_data(ADMINS_FILE, admins)
                await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_admin_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã")
            else:
                await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
        except ValueError:
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã ID")

        # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞
        del admin_states[user_id]
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    if state == "removing_admin" and is_owner(user_id):
        try:
            admin_id = int(message.text.strip())
            if admin_id == OWNER_ID:
                await message.answer("‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞!")
            elif admin_id in admins:
                admins.remove(admin_id)
                save_data(ADMINS_FILE, admins)
                await message.answer(f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_id} —É–¥–∞–ª—ë–Ω")
            else:
                await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
        except ValueError:
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã ID")

        del admin_states[user_id]
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    if state == "creating_promo" and is_admin(user_id):
        text = message.text.strip()
        parts = text.split()

        try:
            if len(parts) == 2:
                value = int(parts[0])
                max_uses = int(parts[1])
                code = generate_promo_code()
            elif len(parts) == 3:
                value = int(parts[0])
                max_uses = int(parts[1])
                code = parts[2].upper()
            else:
                await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –ò—Å–ø–æ–ª—å–∑—É–π: —Å—É–º–º–∞ –ª–∏–º–∏—Ç –∏–ª–∏ —Å—É–º–º–∞ –ª–∏–º–∏—Ç –ö–û–î")
                del admin_states[user_id]
                return

            if code in promocodes:
                await message.answer(f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ {code} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
                del admin_states[user_id]
                return

            promocodes[code] = {
    "value": value,
    "uses": 0,
    "max_uses": max_uses,
    "created_by": user_id
}
            save_data(PROMOCODES_FILE, promocodes)

            await message.answer(
    f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!\n\n"
    f"üìå –ö–æ–¥: `{code}`\n"
    f"üí∞ –°—É–º–º–∞: {value} –º–æ–Ω–µ—Ç\n"
    f"üë• –õ–∏–º–∏—Ç: {max_uses} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π\n\n"
    f"–û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –∏–≥—Ä–æ–∫–∞–º!",
    parse_mode="Markdown"
)
        except (ValueError, IndexError):
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –∏ –ª–∏–º–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ")

    del admin_states[user_id]


# –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω–æ–≤
@dp.message()
async def handle_admin_actions(message: Message):
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–∞–∫–æ–º-—Ç–æ —Ä–µ–∂–∏–º–µ
    if user_id not in admin_states:
        # –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã
        await handle_promo_logic(message)
        return

    state = admin_states[user_id]

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    if state == "adding_admin" and is_owner(user_id):
        try:
            new_admin_id = int(message.text.strip())
            if new_admin_id not in admins:
                admins.append(new_admin_id)
                save_data(ADMINS_FILE, admins)
                await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {new_admin_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã")
            else:
                await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
        except ValueError:
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã ID")

        # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞
        del admin_states[user_id]
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
    if state == "removing_admin" and is_owner(user_id):
        try:
            admin_id = int(message.text.strip())
            if admin_id == OWNER_ID:
                await message.answer("‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞!")
            elif admin_id in admins:
                admins.remove(admin_id)
                save_data(ADMINS_FILE, admins)
                await message.answer(f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {admin_id} —É–¥–∞–ª—ë–Ω")
            else:
                await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
        except ValueError:
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã ID")

        del admin_states[user_id]
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    if state == "creating_promo" and is_admin(user_id):
        text = message.text.strip()
        parts = text.split()

        try:
            if len(parts) == 2:
                value = int(parts[0])
                max_uses = int(parts[1])
                code = generate_promo_code()
            elif len(parts) == 3:
                value = int(parts[0])
                max_uses = int(parts[1])
                code = parts[2].upper()
            else:
                await message.answer("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –ò—Å–ø–æ–ª—å–∑—É–π: —Å—É–º–º–∞ –ª–∏–º–∏—Ç –∏–ª–∏ —Å—É–º–º–∞ –ª–∏–º–∏—Ç –ö–û–î")
                del admin_states[user_id]
                return

            if code in promocodes:
                await message.answer(f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ {code} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
                del admin_states[user_id]
                return

            promocodes[code] = {
                "value": value,
                "uses": 0,
                "max_uses": max_uses,
                "created_by": user_id
            }
            save_data(PROMOCODES_FILE, promocodes)

            await message.answer(
                f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!\n\n"
                f"üìå –ö–æ–¥: `{code}`\n"
                f"üí∞ –°—É–º–º–∞: {value} –º–æ–Ω–µ—Ç\n"
                f"üë• –õ–∏–º–∏—Ç: {max_uses} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π\n\n"
                f"–û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –∏–≥—Ä–æ–∫–∞–º!",
                parse_mode="Markdown"
            )
        except (ValueError, IndexError):
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –∏ –ª–∏–º–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ")

        del admin_states[user_id]
        return

    # –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç
    if state == "giving_money" and is_admin(user_id):
        parts = message.text.strip().split()

        try:
            if len(parts) == 2:
                target_id = str(parts[0])
                amount = int(parts[1])

                if target_id not in users:
                    users[target_id] = {"balance": 0, "last_luck": None}

                users[target_id]["balance"] += amount
                save_data(USERS_FILE, users)

                await message.answer(f"‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ {amount} –º–æ–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_id}")

                try:
                    await bot.send_message(
                        int(target_id),
                        f"üí∞ –¢–µ–±–µ –Ω–∞—á–∏—Å–ª–µ–Ω–æ {amount} –º–æ–Ω–µ—Ç!\n"
                        f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {users[target_id]['balance']}"
                    )
                except:
                    await message.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
            else:
                await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: user_id —Å—É–º–º–∞")
        except (ValueError, IndexError):
            await message.answer("‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏ ID –∏ —Å—É–º–º—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ")

        del admin_states[user_id]
        return


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
async def handle_promo_logic(message: Message):
    if message.text.startswith('/'):
        return

    code = message.text.upper()
    user_id = str(message.from_user.id)

    if code in promocodes:
        promo = promocodes[code]

        if promo["uses"] >= promo["max_uses"]:
            await message.answer("‚ùå –≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑!")
            return

        users[user_id]["balance"] += promo["value"]
        promo["uses"] += 1

        save_data(USERS_FILE, users)
        save_data(PROMOCODES_FILE, promocodes)

        await message.answer(
            f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n"
            f"üí∞ –¢—ã –ø–æ–ª—É—á–∏–ª {promo['value']} –º–æ–Ω–µ—Ç\n"
            f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {users[user_id]['balance']}"
        )

        try:
            await bot.send_message(
                promo["created_by"],
                f"üéü –ü—Ä–æ–º–æ–∫–æ–¥ {code} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.full_name} (ID: {user_id})\n"
                f"–û—Å—Ç–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: {promo['max_uses'] - promo['uses']}"
            )
        except:
            pass


@dp.callback_query(lambda c: c.data == "game")
async def game(callback: CallbackQuery):
    await callback.message.answer("üéÆ –ú–∏–Ω–∏-–∏–≥—Ä–∞ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!")
    await callback.answer()


@dp.callback_query(lambda c: c.data == "shop")
async def shop(callback: CallbackQuery):
    await callback.message.answer("üõí –ú–∞–≥–∞–∑–∏–Ω –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!")
    await callback.answer()


@dp.callback_query(lambda c: c.data == "rules")
async def rules(callback: CallbackQuery):
    await callback.message.answer(
        "üìú –ü—Ä–∞–≤–∏–ª–∞ –∏–≤–µ–Ω—Ç–∞:\n\n"
        "1. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —É–¥–∞—á—É (0-1000 –º–æ–Ω–µ—Ç)\n"
        "2. –ü—Ä–æ–º–æ–∫–æ–¥—ã –¥–∞—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã\n"
        "3. –í –º–∞–≥–∞–∑–∏–Ω–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –±–æ–Ω—É—Å—ã\n"
        "4. –°–ª–µ–¥–∏ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!"
    )


    await callback.answer()


async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
